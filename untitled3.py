# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/19odwT8mkF7SaBtBojNcqAxXyLNTsfoK2
"""

from g4f.client import Client
import telebot
import requests
from datetime import datetime, timedelta
import pytz

TOKEN = '7787223686:AAHSoSOdf49a9z_Cts1s1zJx4sy1UzsDh1s'
bot = telebot.TeleBot(TOKEN)
weather_api_key = 'e74c7b0d6df55c70eda3289ef83ba688'


clothing_recommendations = {
    'hot': "ÐÐ° ÑƒÐ»Ð¸Ñ†Ðµ Ð¶Ð°Ñ€ÐºÐ¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: Ð»ÐµÐ³ÐºÐ°Ñ Ð¾Ð´ÐµÐ¶Ð´Ð°, ÑˆÐ¾Ñ€Ñ‚Ñ‹, Ñ„ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ°, Ð³Ð¾Ð»Ð¾Ð²Ð½Ð¾Ð¹ ÑƒÐ±Ð¾Ñ€, ÑÐ¾Ð»Ð½Ñ†ÐµÐ·Ð°Ñ‰Ð¸Ñ‚Ð½Ñ‹Ðµ Ð¾Ñ‡ÐºÐ¸.",
    'warm': "Ð¢ÐµÐ¿Ð»Ð¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: Ñ„ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ°, Ð»ÐµÐ³ÐºÐ¸Ðµ Ð±Ñ€ÑŽÐºÐ¸ Ð¸Ð»Ð¸ ÑŽÐ±ÐºÐ°, Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ð·ÑÑ‚ÑŒ Ð»ÐµÐ³ÐºÑƒÑŽ ÐºÑƒÑ€Ñ‚ÐºÑƒ Ð½Ð° Ð²ÐµÑ‡ÐµÑ€.",
    'mild': "Ð£Ð¼ÐµÑ€ÐµÐ½Ð½Ð¾ Ñ‚ÐµÐ¿Ð»Ð¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: Ñ€ÑƒÐ±Ð°ÑˆÐºÐ° Ñ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¼ Ñ€ÑƒÐºÐ°Ð²Ð¾Ð¼, Ð´Ð¶Ð¸Ð½ÑÑ‹, Ð»ÐµÐ³ÐºÐ°Ñ ÐºÑƒÑ€Ñ‚ÐºÐ°.",
    'cool': "ÐŸÑ€Ð¾Ñ…Ð»Ð°Ð´Ð½Ð¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: ÑÐ²Ð¸Ñ‚ÐµÑ€, Ð´Ð¶Ð¸Ð½ÑÑ‹, Ð²ÐµÑ‚Ñ€Ð¾Ð²ÐºÐ° Ð¸Ð»Ð¸ Ð»ÐµÐ³ÐºÐ¾Ðµ Ð¿Ð°Ð»ÑŒÑ‚Ð¾.",
    'cold': "Ð¥Ð¾Ð»Ð¾Ð´Ð½Ð¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: Ñ‚ÐµÐ¿Ð»Ð¾Ðµ Ð¿Ð°Ð»ÑŒÑ‚Ð¾, ÑˆÐ°Ð¿ÐºÐ°, ÑˆÐ°Ñ€Ñ„, Ð¿ÐµÑ€Ñ‡Ð°Ñ‚ÐºÐ¸, ÑƒÑ‚ÐµÐ¿Ð»ÐµÐ½Ð½Ð°Ñ Ð¾Ð±ÑƒÐ²ÑŒ.",
    'very_cold': "ÐžÑ‡ÐµÐ½ÑŒ Ñ…Ð¾Ð»Ð¾Ð´Ð½Ð¾. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ: Ð·Ð¸Ð¼Ð½ÐµÐµ Ð¿Ð°Ð»ÑŒÑ‚Ð¾ Ð¸Ð»Ð¸ Ð¿ÑƒÑ…Ð¾Ð²Ð¸Ðº, Ñ‚ÐµÑ€Ð¼Ð¾Ð±ÐµÐ»ÑŒÐµ, Ñ‚ÐµÐ¿Ð»Ð°Ñ Ð¾Ð±ÑƒÐ²ÑŒ, ÑˆÐ°Ð¿ÐºÐ°, ÑˆÐ°Ñ€Ñ„, Ð¿ÐµÑ€Ñ‡Ð°Ñ‚ÐºÐ¸."
}

@bot.message_handler(commands=['start'])
def start(message):
    welcome_text = (
        f"ÐŸÑ€Ð¸Ð²ÐµÑ‚, {message.from_user.first_name}! Ð¯ Ð±Ð¾Ñ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‚ÐµÐ±Ðµ Ñ:\n"
        "1. ÐŸÐ¾Ð³Ð¾Ð´Ð¾Ð¹ Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸ÑÐ¼Ð¸ ÐºÐ°Ðº Ð¾Ð´ÐµÑ‚ÑŒÑÑ\n"
        "2. ÐžÑ‚Ð²ÐµÑ‚Ð°Ð¼Ð¸ Ð½Ð° Ð»ÑŽÐ±Ñ‹Ðµ Ñ‚Ð²Ð¾Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹\n\n"
        "ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¿Ð¸ÑˆÐ¸ Ð¼Ð½Ðµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ð¾Ñ€Ð¾Ð´Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð° Ð¿Ð¾Ð³Ð¾Ð´Ñ‹ Ð¸Ð»Ð¸ Ð·Ð°Ð´Ð°Ð¹ Ð»ÑŽÐ±Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ!"
    )
    bot.send_message(message.chat.id, welcome_text)

def get_weather(city):
    try:
        url = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={weather_api_key}&units=metric&lang=ru"
        response = requests.get(url)
        data = response.json()

        if data['cod'] != 200:
            return None


        timezone_offset = data['timezone']


        sunrise_utc = datetime.fromtimestamp(data['sys']['sunrise'])
        sunset_utc = datetime.fromtimestamp(data['sys']['sunset'])


        sunrise_local = sunrise_utc + timedelta(seconds=timezone_offset)
        sunset_local = sunset_utc + timedelta(seconds=timezone_offset)

        weather = {
            'city': data['name'],
            'temp': round(data['main']['temp']),
            'feels_like': round(data['main']['feels_like']),
            'description': data['weather'][0]['description'],
            'humidity': data['main']['humidity'],
            'wind': data['wind']['speed'],
            'sunrise': sunrise_local.strftime('%H:%M'),
            'sunset': sunset_local.strftime('%H:%M')
        }
        return weather
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ð¾Ð³Ð¾Ð´Ñ‹: {e}")
        return None

def get_clothing_recommendation(temp):
    if temp > 25:
        return clothing_recommendations['hot']
    elif 20 <= temp <= 25:
        return clothing_recommendations['warm']
    elif 15 <= temp < 20:
        return clothing_recommendations['mild']
    elif 5 <= temp < 15:
        return clothing_recommendations['cool']
    elif -5 <= temp < 5:
        return clothing_recommendations['cold']
    else:
        return clothing_recommendations['very_cold']

@bot.message_handler(content_types=['text'])
def handle_message(message):

    weather = get_weather(message.text)
    if weather:
        weather_text = (
            f"ÐŸÐ¾Ð³Ð¾Ð´Ð° Ð² {weather['city']}:\n"
            f"ðŸŒ¡ Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: {weather['temp']}Â°C (Ð¾Ñ‰ÑƒÑ‰Ð°ÐµÑ‚ÑÑ ÐºÐ°Ðº {weather['feels_like']}Â°C)\n"
            f"â˜ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: {weather['description'].capitalize()}\n"
            f"ðŸ’§ Ð’Ð»Ð°Ð¶Ð½Ð¾ÑÑ‚ÑŒ: {weather['humidity']}%\n"
            f"ðŸŒ¬ Ð’ÐµÑ‚ÐµÑ€: {weather['wind']} Ð¼/Ñ\n"
            f"ðŸŒ… Ð’Ð¾ÑÑ…Ð¾Ð´: {weather['sunrise']}\n"
            f"ðŸŒ‡ Ð—Ð°ÐºÐ°Ñ‚: {weather['sunset']}\n\n"
            f"{get_clothing_recommendation(weather['temp'])}"
        )
        bot.send_message(message.chat.id, weather_text)
    else:

        client = Client()
        try:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": message.text}],
            )
            bot.send_message(message.chat.id, response.choices[0].message.content)
        except Exception as e:
            bot.send_message(message.chat.id, f"Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ð¿Ñ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°: {str(e)}")

if __name__ == '__main__':
    print("Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½...")
    bot.polling()